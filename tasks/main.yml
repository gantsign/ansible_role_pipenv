---
- name: install system pip
  become: yes
  package:
    name: 'python{{ pipenv_python_version_suffix }}-pip'
    state: present

# pip module seems to fail idempotence with --user
- name: check if Pipenv installed
  become: yes
  become_user: '{{ item }}'
  stat:
    path: '~/.local/bin/pipenv'
  register: pipenv_check
  with_items: '{{ pipenv_users }}'

- name: install user pip
  become: yes
  become_user: '{{ item.item }}'
  pip:
    name: pip
    state: present
    extra_args: --user
  when:
    - not item.stat.exists
  loop_control:
    label: "{{ item.item }}"
  with_items: '{{ pipenv_check.results }}'

- name: install Pipenv
  become: yes
  become_user: '{{ item.item }}'
  pip:
    executable: '~/.local/bin/pip'
    name: pipenv
    state: present
    extra_args: --user
  when:
    - not item.stat.exists
  loop_control:
    label: "{{ item.item }}"
  with_items: '{{ pipenv_check.results }}'
